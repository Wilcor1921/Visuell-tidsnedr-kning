<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Visuell Tidsnedräknare</title>
<style>
  :root{
    --bg:#0f1113; --panel:#171a1d; --panel2:#1a1d20ee; --text:#e7e9ea; --muted:#a7adb3;
    --accent:#34d399; --border:#2b2f33; --pad:16px; --cols: 15;
  }
  *{box-sizing:border-box}
  html,body{min-height:100%}
  body{
    margin:0; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* Sticky topp: snabba kontroller + stor total tid */
  .topbar{ position:sticky; top:0; z-index:60; background:linear-gradient(180deg,#0f1113,#121417);
    border-bottom:1px solid var(--border); padding:10px var(--pad); }
  .topgrid{ display:grid; gap:10px; grid-template-columns: 1fr auto; align-items:center; }
  .totaltime{ text-align:center; font-size:34px; font-weight:800; letter-spacing:.3px; }
  .totaltime small{ font-size:14px; color:var(--muted); font-weight:600; margin-left:6px }

  .quick-controls{ display:grid; gap:8px; grid-template-columns: 1fr 1fr; }
  .field{ display:flex; gap:8px; align-items:center; justify-content:space-between;
    background:#121417; border:1px solid var(--border); border-radius:12px; padding:8px 10px; }
  .field label{ font-size:12px; color:var(--muted) }
  .field input[type=number], .field select{
    width:96px; max-width:45vw; padding:6px 8px; border-radius:8px; border:1px solid #2b2f33;
    background:#0e1011; color:#fff; font-size:14px;
  }
  .startrow{ display:flex; gap:8px; justify-content:center; margin-top:8px; }
  .btn{ cursor:pointer; padding:10px 14px; border-radius:12px; border:1px solid transparent; font-weight:700; font-size:14px }
  .btn.primary{ background:var(--accent); color:#0b0f10 }
  .btn.ghost{ background:#22272b; color:#fff; border-color:#30353a }

  .advanced{ background:var(--panel2); border-top:1px solid var(--border); padding:10px var(--pad) 14px; }
  details{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#14171a }
  summary{ cursor:pointer; list-style:none; padding:12px 14px; font-weight:700; font-size:14px; background:#14171a; border-bottom:1px solid #1f2428 }
  summary::-webkit-details-marker{ display:none }
  .panel{ padding:12px 14px }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px }
  .row label{ font-size:12px; color:var(--muted) }
  input[type=range]{ width:100% }
  input[type=number]{ width:100px; padding:8px 10px; background:#0e1011; color:#fff; border:1px solid var(--border); border-radius:10px }
  .choices{ display:flex; gap:8px; flex-wrap:wrap }
  .choice{ padding:8px 10px; border-radius:10px; border:1px solid #3a3f44; background:#0e1011; color:#fff; cursor:pointer; font-size:13px }
  .choice.active{ background:var(--accent); color:#0b0f10; border-color:#27c08a }

  .wrap{ padding:12px var(--pad) 24px }
  .card{ background:var(--panel2); border:1px solid var(--border); border-radius:16px; padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.25); backdrop-filter: blur(6px); }
  .toprow{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
  .badge{ font-size:12px; color:#c5cbd1 }
  .grid-lamps{ display:grid; gap:6px }

  /* Lampor i normal-läge: rektanglar (snygg preview) */
  .lamp{
    aspect-ratio: 4/3; min-height:32px; border-radius:12px;
    transition: filter .25s ease, opacity .25s ease, background .25s ease;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.45), 0 6px 14px rgba(0,0,0,.25);
  }
  .lamp.off{ filter:grayscale(60%) brightness(40%) contrast(80%); opacity:.35; box-shadow: inset 0 0 0 1px #3a3a3a }

  .clock{ margin-top:10px; text-align:center; font-variant-numeric:tabular-nums; font-size:22px; color:#dff3ee }
  .progress{ height:6px; background:#2b2f33; border-radius:999px; overflow:hidden; margin-top:8px }
  .progress > div{ height:100%; width:0; background:linear-gradient(90deg,#34d399,#22d3ee) }

  @media (min-width: 980px){
    .topgrid{ grid-template-columns: 1fr auto 1fr }
    .totaltime{ font-size:40px }
    .wrap{ display:grid; grid-template-columns: 1.1fr 2fr; gap:16px }
    .startrow{ justify-content:flex-end }
  }

  /* ===== FULLSKÄRMSLÄGE: bara LED-cirklar + flytande kontroller ===== */
  body.fullscreen-mode .topbar,
  body.fullscreen-mode .advanced,
  body.fullscreen-mode .clock,
  body.fullscreen-mode .badge,
  body.fullscreen-mode details,
  body.fullscreen-mode summary {
    display: none !important;
  }
  body.fullscreen-mode .wrap { padding: 0 }
  body.fullscreen-mode .card { background: none; border: none; box-shadow: none; padding: 0 }
  body.fullscreen-mode #lampWrap{
    height: 100vh; width: 100vw; gap: 6px; padding: 10px; box-sizing: border-box;
    display: grid; grid-template-columns: repeat(var(--cols), 1fr); grid-auto-rows: 1fr;
  }
  body.fullscreen-mode .lamp{
    aspect-ratio: 1 / 1;           /* gör dem kvadratiska */
    border-radius: 9999px;         /* ...och runda */
    box-shadow: 0 0 0 2px rgba(255,255,255,.15), 0 8px 20px rgba(0,0,0,.35);
  }

  /* Flytande kontrollpanel i fullskärm */
  .fs-controls{
    position: fixed; left: 50%; transform: translateX(-50%);
    bottom: max(12px, env(safe-area-inset-bottom));
    display: none; z-index: 70;
    background: rgba(0,0,0,.55); backdrop-filter: blur(6px);
    border: 1px solid #2b2f33; border-radius: 999px; padding: 8px;
  }
  .fs-controls.show{ display:flex; gap:8px; align-items:center }
  .fs-btn{
    cursor:pointer; padding:10px 14px; border-radius:999px; border:1px solid #3a3f44;
    background:#121417; color:#e7e9ea; font-weight:700; font-size:14px;
  }
  .fs-btn.primary{ background:var(--accent); color:#0b0f10; border-color:#27c08a }

  /* 3-2-1 countdown overlay (kvar om du vill) */
  .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80 }
  .overlay.show{ display:flex }
  .countdown{ background:rgba(0,0,0,.6); color:#fff; font-size:24vw; font-weight:900; line-height:1 }
</style>
</head>
<body>

<!-- Sticky top -->
<div class="topbar">
  <div class="topgrid">
    <div class="quick-controls">
      <div class="field"><label>Lampor</label><input type="number" id="lampCount" value="15" min="5" max="120"></div>
      <div class="field"><label>Min/lampa</label><input type="number" id="minutesPerLamp" value="2" min="0.5" step="0.5" max="60"></div>
      <div class="field"><label>Per rad</label><input type="number" id="lampsPerRow" value="15" min="1" max="120"></div>
      <div class="field"><label>Tema</label>
        <select id="colorTheme">
          <option value="gyr">Grön→Gul→Röd</option>
          <option value="rainbow">Regnbåge</option>
          <option value="white">Vit</option>
        </select>
      </div>
      <div class="field"><label>Ordning</label>
        <select id="orderMode">
          <option value="row">Radvis</option>
          <option value="col">Kolumnvis</option>
        </select>
      </div>
      <div class="field"><label>Riktning</label>
        <select id="direction">
          <option value="ltr">Vänster→Höger</option>
          <option value="rtl">Höger→Vänster</option>
        </select>
      </div>
    </div>

    <div>
      <div class="totaltime"><span id="totalTimeDisplay">30</span><small>min</small></div>
      <div class="startrow">
        <button class="btn primary" id="startBtn">Starta i fullskärm</button>
        <button class="btn ghost" id="resetBtn" style="display:none">Nollställ</button>
      </div>
    </div>
  </div>
</div>

<!-- Avancerat -->
<div class="advanced">
  <details>
    <summary>Fler inställningar</summary>
    <div class="panel">
      <div class="row"><label for="lampsRange">Antal lampor</label><input id="lampsRange" type="range" min="5" max="120" value="15"></div>
      <div class="row"><label for="mplRange">Minuter per lampa</label><input id="mplRange" type="range" min="0.5" max="30" step="0.5" value="2"></div>
      <div class="row"><label for="perRowRange">Lampor per rad</label><input id="perRowRange" type="range" min="1" max="120" value="15"></div>
      <div class="row">
        <span style="font-size:12px;color:var(--muted)">Färgtema</span>
        <div class="choices" id="themeChoices">
          <button class="choice active" data-scheme="gyr">Grön→Gul→Röd</button>
          <button class="choice" data-scheme="rainbow">Regnbåge</button>
          <button class="choice" data-scheme="white">Vit</button>
        </div>
      </div>
      <div class="row" style="margin-top:4px">
        <label style="display:flex;align-items:center;gap:10px">
          <input type="checkbox" id="sound" checked>
          <span style="font-size:13px">Ljudsignal när tiden är slut</span>
        </label>
      </div>
      <div class="progress" title="Total progress"><div id="progressFill"></div></div>
    </div>
  </details>
</div>

<!-- Innehåll -->
<div class="wrap">
  <div class="card">
    <div class="toprow">
      <div style="font-weight:800">Visuell Nedräkning</div>
      <div class="badge" id="panelBadge">15 × 2 min</div>
    </div>
    <div id="lampWrap" class="grid-lamps"></div>
    <div class="clock" id="clock">00:00</div>
  </div>
</div>

<!-- Fullscreen flytande kontroller -->
<div class="fs-controls" id="fsControls">
  <button class="fs-btn primary" id="fsPauseBtn">Pausa</button>
  <button class="fs-btn" id="fsExitBtn">Avsluta fullskärm</button>
</div>

<!-- 3-2-1 overlay (valfritt) -->
<div class="overlay" id="countOverlay"><div class="countdown" id="countNum">3</div></div>

<script>
  // ======= STATE =======
  const state = {
    lamps: 15, mpl: 2, perRow: 15,
    scheme: 'gyr', orderMode: 'row', direction: 'ltr',
    sound: true,
    running: false, paused: false, finished: false,
    off: 0, elapsedInLampMs: 0, stepMs: 2*60*1000,
    previewTimer: null, tick: null,
    wakeLock: null, audioCtx: null
  };

  // ======= ELEMENTS =======
  const $ = id => document.getElementById(id);
  const lampCount = $('lampCount'), minutesPerLamp = $('minutesPerLamp'), lampsPerRow = $('lampsPerRow');
  const colorTheme = $('colorTheme'), orderModeSel = $('orderMode'), directionSel=$('direction');
  const totalTimeDisplay = $('totalTimeDisplay');
  const lampsRange=$('lampsRange'), mplRange=$('mplRange'), perRowRange=$('perRowRange'), soundCb=$('sound');
  const startBtn=$('startBtn'), resetBtn=$('resetBtn');
  const lampWrap=$('lampWrap'), clock=$('clock'), progressFill=$('progressFill'), panelBadge=$('panelBadge');
  const themeChoices = $('themeChoices');
  const fsControls = $('fsControls'), fsPauseBtn=$('fsPauseBtn'), fsExitBtn=$('fsExitBtn');
  const countOverlay=$('countOverlay'), countNum=$('countNum');

  // ======= HELPERS =======
  const clamp=(v,mi,ma)=>Math.max(mi,Math.min(ma,v));
  function updateStep(){ state.stepMs = Math.max(10, state.mpl * 60 * 1000); }
  const hueCss=h=>`linear-gradient(180deg, hsl(${h} 90% 60%), hsl(${h} 80% 50%))`;
  function colorFor(i,total){
    const t = total<=1 ? 0 : i/(total-1);
    if(state.scheme==='white') return 'linear-gradient(180deg,#f3f4f6,#d1d5db)';
    if(state.scheme==='gyr'){ const hue = 120*(1-t); return hueCss(hue); }
    const hue = 240 + 360*(1-t); return hueCss(hue); // rainbow
  }
  const dimStyle = base => `filter:grayscale(60%) brightness(40%) contrast(80%);opacity:.35;box-shadow:inset 0 0 0 1px #3a3a3a;background:${base}`;
  const fmtMS = (ms)=>{ ms=Math.max(0,ms|0); const s=Math.floor(ms/1000), m=Math.floor(s/60), sec=s%60; return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0'); };
  function renderTotal(){ totalTimeDisplay.textContent = (state.lamps * state.mpl).toString(); }

  function buildOrderMap(){
    const cols = clamp(state.perRow,1,state.lamps);
    const rows = Math.ceil(state.lamps/cols);
    const order = [];
    if(state.orderMode==='row'){
      for(let r=0;r<rows;r++){
        const dir = state.direction==='ltr';
        for(let c=dir?0:cols-1; dir?c<cols:c>=0; c+=dir?1:-1){
          const idx=r*cols+c; if(idx<state.lamps) order.push(idx);
        }
      }
    }else{
      const dir = state.direction==='ltr';
      for(let c=dir?0:cols-1; dir?c<cols:c>=0; c+=dir?1:-1){
        for(let r=0;r<rows;r++){
          const idx=r*cols+c; if(idx<state.lamps) order.push(idx);
        }
      }
    }
    const map=new Map(); order.forEach((idx,pos)=>map.set(idx,pos)); return map;
  }
  let orderMap = buildOrderMap();

  function renderLamps(offCount){
    const cols = clamp(state.perRow,1,state.lamps);
    document.documentElement.style.setProperty('--cols', cols);
    lampWrap.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
    lampWrap.innerHTML = '';
    for(let i=0;i<state.lamps;i++){
      const base = colorFor(i, state.lamps);
      const pos = orderMap.get(i) ?? i;
      const isOff = pos < offCount;               // släck första 'offCount'
      const div = document.createElement('div');
      div.className = 'lamp' + (isOff?' off':'');
      div.style = isOff ? dimStyle(base) : `background:${base}`;
      lampWrap.appendChild(div);
    }
  }

  function renderClockAndProgress(){
    const totalMs = state.lamps*state.stepMs;
    const elapsedMs = state.off*state.stepMs + state.elapsedInLampMs;
    const remainingMs = totalMs - elapsedMs;
    clock.textContent = fmtMS(remainingMs);
    const ratio = totalMs>0 ? Math.min(1, Math.max(0, elapsedMs/totalMs)) : 0;
    progressFill.style.width = (ratio*100).toFixed(3) + '%';
  }

  function renderPanel(){
    panelBadge.textContent = `${state.lamps} × ${state.mpl} min`;
    renderLamps(state.off);
    renderClockAndProgress();
    resetBtn.style.display = (state.running || state.finished) ? 'inline-block' : 'none';
    // uppdatera pausknappstext om i fullskärm
    fsPauseBtn.textContent = state.paused ? 'Fortsätt' : 'Pausa';
  }

  // Demo: en gång per ändring
  function startPreviewOnce(){
    stopPreview(); state.off=0; renderPanel();
    state.previewTimer = setInterval(()=>{
      state.off += 1; renderPanel();
      if(state.off >= state.lamps){ stopPreview(); state.off=0; renderPanel(); }
    }, 120);
  }
  function stopPreview(){ if(state.previewTimer){ clearInterval(state.previewTimer); state.previewTimer=null; } }

  // Audio beep
  function beep(){
    try{
      const ctx = state.audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      state.audioCtx = ctx;
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type='sine'; o.frequency.value=880; g.gain.value=0.0001;
      o.connect(g); g.connect(ctx.destination); o.start();
      const now=ctx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.2, now + 0.05);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 1.2);
      o.stop(now + 1.25);
    }catch(e){}
  }

  // Wake & Fullscreen
  async function requestWake(){ try{ if('wakeLock' in navigator){ state.wakeLock = await navigator.wakeLock.request('screen'); } }catch(e){} }
  async function releaseWake(){ try{ await state.wakeLock?.release?.(); state.wakeLock=null; }catch(e){} }
  async function enterFs(){ try{ await document.documentElement.requestFullscreen?.(); if (screen.orientation?.lock) { try{ await screen.orientation.lock('landscape'); }catch(e){} } }catch(e){} }
  async function exitFs(){ try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(e){} }

  // 3-2-1 overlay (valfritt, snabbt)
  async function startCountDownOverlay(){
    countOverlay.classList.add('show');
    for(const n of ['3','2','1']){
      countNum.textContent = n;
      await new Promise(r=>setTimeout(r, 600));
    }
    countOverlay.classList.remove('show');
  }

  // TIMER
  function startTimer(){
    state.tick = setInterval(()=>{
      if(!state.running || state.finished || state.paused) return;
      state.elapsedInLampMs += 200;
      if(state.elapsedInLampMs >= state.stepMs){
        state.elapsedInLampMs -= state.stepMs;
        state.off += 1;
        if(state.off >= state.lamps){
          state.finished = true; state.running = false;
          if(state.sound) beep();
          // vi lämnar fullskärm manuellt om man vill (via knappen)
        }
      }
      renderPanel();
    }, 200);
  }
  function stopTimer(){ if(state.tick){ clearInterval(state.tick); state.tick=null; } }

  // Synk
  function syncRanges(){ lampsRange.value = state.lamps; mplRange.value = state.mpl; perRowRange.value = state.perRow; }
  function syncQuick(){
    lampCount.value = state.lamps; minutesPerLamp.value = state.mpl; lampsPerRow.value = state.perRow;
    colorTheme.value = state.scheme; orderModeSel.value=state.orderMode; directionSel.value=state.direction;
    soundCb.checked = state.sound;
  }
  function applyAndPreview(){ updateStep(); renderTotal(); orderMap = buildOrderMap(); renderPanel(); startPreviewOnce(); }

  // Events – quick controls
  lampCount.addEventListener('input', ()=>{ state.lamps = clamp(+lampCount.value,5,120); syncRanges(); applyAndPreview(); });
  minutesPerLamp.addEventListener('input', ()=>{ state.mpl = clamp(+minutesPerLamp.value||0.5,0.5,60); syncRanges(); applyAndPreview(); });
  lampsPerRow.addEventListener('input', ()=>{ state.perRow = clamp(+lampsPerRow.value,1,120); syncRanges(); applyAndPreview(); });
  colorTheme.addEventListener('change', ()=>{ state.scheme = colorTheme.value; applyAndPreview(); });
  orderModeSel.addEventListener('change', ()=>{ state.orderMode = orderModeSel.value; applyAndPreview(); });
  directionSel.addEventListener('change', ()=>{ state.direction = directionSel.value; applyAndPreview(); });

  // Sliders + tema-knappar
  lampsRange.addEventListener('input', ()=>{ state.lamps = clamp(+lampsRange.value,5,120); syncQuick(); applyAndPreview(); });
  mplRange.addEventListener('input', ()=>{ state.mpl = clamp(+mplRange.value,0.5,60); syncQuick(); applyAndPreview(); });
  perRowRange.addEventListener('input', ()=>{ state.perRow = clamp(+perRowRange.value,1,120); syncQuick(); applyAndPreview(); });
  themeChoices.addEventListener('click', (e)=>{
    const b = e.target.closest('.choice'); if(!b) return;
    state.scheme = b.dataset.scheme;
    document.querySelectorAll('.choice').forEach(x=>x.classList.toggle('active', x.dataset.scheme===state.scheme));
    applyAndPreview();
  });

  // Start / Reset
  startBtn.addEventListener('click', async ()=>{
    document.body.classList.add('fullscreen-mode');
    $('fsControls').classList.add('show');
    await startCountDownOverlay();
    await enterFs(); await requestWake();
    stopPreview();
    state.running = true; state.finished=false; state.paused=false;
    state.off = 0; state.elapsedInLampMs = 0;  // alla tända vid start
    renderPanel(); startTimer();
  });

  resetBtn.addEventListener('click', async ()=>{
    // nollställ och lämna ev. fullskärm
    document.body.classList.remove('fullscreen-mode');
    $('fsControls').classList.remove('show');
    state.running=false; state.finished=false; state.paused=false;
    state.off=0; state.elapsedInLampMs=0;
    stopTimer(); await releaseWake(); await exitFs(); applyAndPreview();
  });

  // ===== Fullscreen: PAUSA & AVSLUTA =====
  fsPauseBtn.addEventListener('click', ()=>{
    state.paused = !state.paused;
    fsPauseBtn.textContent = state.paused ? 'Fortsätt' : 'Pausa';
  });
  fsExitBtn.addEventListener('click', async ()=>{
    // lämna bara fullskärm (timern fortsätter i bakgrunden)
    document.body.classList.remove('fullscreen-mode');
    $('fsControls').classList.remove('show');
    await releaseWake();
    await exitFs();
  });

  // Tangenter: mellanslag = pausa/fortsätt, Esc = lämna fullskärm, F = toggla fullskärm
  window.addEventListener('keydown', async (e)=>{
    if(e.code==='Space'){
      if(state.running && !state.finished){
        state.paused = !state.paused;
        fsPauseBtn.textContent = state.paused ? 'Fortsätt' : 'Pausa';
        e.preventDefault();
      }
    } else if(e.key==='Escape'){
      if(document.body.classList.contains('fullscreen-mode')){
        document.body.classList.remove('fullscreen-mode');
        $('fsControls').classList.remove('show');
        await releaseWake(); await exitFs();
      }
    } else if(e.key.toLowerCase()==='f'){
      if(!document.fullscreenElement){
        document.body.classList.add('fullscreen-mode');
        $('fsControls').classList.add('show');
        await enterFs(); await requestWake();
      }else{
        document.body.classList.remove('fullscreen-mode');
        $('fsControls').classList.remove('show');
        await releaseWake(); await exitFs();
      }
    }
  });

  // Init
  function init(){
    updateStep(); renderTotal(); syncRanges(); syncQuick();
    orderMap = buildOrderMap(); renderPanel(); startPreviewOnce();
  }
  setTimeout(init,0);
</script>
</body>
</html>
